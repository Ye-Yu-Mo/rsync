# **基于 rsync 的跨平台任务同步工具 — 产品需求文档（PRD / Prompt）**

> 平台：macOS、Windows
> 同步方向：**单向（本地 → 远程）**

---

# **1. 技术选型（给你定好了，不要再纠结）**

1. **核心同步工具：rsync**

   * macOS 自带 rsync。
   * Windows 无 rsync，**随应用内置 rsync.exe（cygwin/MinGW 版本皆可）**。
   * 工具负责调用子进程执行 rsync。

2. **主程序：**

   * UI 框架：**Electron**（因为你要跨平台 GUI，又不是要做高性能原生 UI，别自找麻烦）
   * 后端逻辑：Node.js
   * 本地数据库：SQLite（任务列表、执行日志、小型配置完全够用）

3. **文件系统监控：非必须**

   * 因为你是定时同步，不是实时同步。

---

# **2. 功能概述**

分两层：

1. **任务编辑页（新建/编辑任务）**
2. **任务管理页（任务列表与状态管理）**

核心：管理一系列 rsync“任务”，每个任务定时执行，支持增量备份与版本保留。

---

# **3. 任务编辑页面（核心配置项）**

### 字段（全部必填）

| 字段         | 说明             |
| ---------- | -------------- |
| 任务名称       | 用户自定义，不影响逻辑    |
| 远程 IP      | rsync SSH 目标主机 |
| 远程端口       | 默认 22          |
| 用户名        | SSH 登录         |
| 密码/私钥      | 选择其一（建议支持私钥）   |
| 本地目录       | 同步源目录          |
| 远程目录       | 同步目标目录         |
| 同步时间间隔（分钟） | 定时执行周期，最小 1 分钟 |
| 是否启用版本保留   | 默认开启           |
| 保留版本数      | 固定为 10（不让用户乱改） |
| Trash 功能   | 开关（默认开）        |

---

### 任务编辑页面的“底层实现要求”

* 生成 rsync 命令参数模板：

```
rsync -av --delete \
      --backup --backup-dir=<remote_dir>/.versions/<timestamp>/ \
      <local_dir>/ user@host:<remote_dir>
```

* Trash 目录

  * 远程的 `.trash/`
  * 删除动作丢进 trash，并记录时间
  * 90 天自动清理

---

# **4. 任务管理页面（列表展示）**

### 列表字段

| 字段     | 说明                  |
| ------ | ------------------- |
| 任务名称   | 点击可进入编辑             |
| 上次同步时间 | yyyy-MM-dd HH:mm:ss |
| 同步状态   | 成功 / 失败 / 进行中       |
| 立即同步按钮 | 强制执行一次              |
| 开关     | 启用 / 禁用任务           |
| 查看日志   | 打开日志窗口              |

---

# **5. 同步逻辑（关键点，不要搞错）**

### 1）**单向同步：本地 → 远程**

你已经说得很清楚，不做反向同步。
这样可以避免冲突、合并、复杂度地狱。

### 2）**增量同步**

rsync 默认做到。
每次同步只推送变化的文件。

### 3）**版本保留（10 个版本）**

用 rsync 的 `--backup` 与 `--backup-dir` 完成。
目标结构：

```
remote_dir/
    real_files...
    .versions/
        2025-01-01_12-00-00/
        2025-01-01_18-00-00/
        ...最多 10 个
```

超出的按时间排序删除。

### 4）**Trash 机制（90 天自动删除）**

删除动作 → 移动到 `.trash/<timestamp>/path/to/file`
后台 cron 每天执行：

```
删除超过 90 天的 trash 内容
```

---

# **6. Windows 内置 rsync 要求**

* 随应用打包 `rsync.exe`、`ssh.exe`、相关 DLL。
* 启动时检查 PATH，优先使用内置版本。
* 必须处理 Windows 路径转义，避免路径格式搞砸 rsync。

---

# **7. 日志系统**

每个任务保存最近 100 条日志：

| 字段       | 内容             |
| -------- | -------------- |
| 时间       | 执行时间           |
| 结果       | success / fail |
| rsync 输出 | stdout/stderr  |
| 耗时       | 秒              |

---

# **8. 错误处理（必须做到）**

* SSH 无法连接 → 标记失败
* 权限错误 → 标记失败
* rsync 返回码 ≠ 0 → 写日志，不中断任务调度
* 路径不存在 → UI 阻止保存
